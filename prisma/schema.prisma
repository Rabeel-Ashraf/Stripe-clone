// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant isolation: All core tables include merchantId for data separation
// Soft-delete pattern: isDeleted flag for audit trail compliance
// Indexes optimized for common query patterns and performance

model Merchant {
  id                    String    @id @default(cuid())
  email                 String    @unique
  emailVerified         DateTime?
  passwordHash          String
  businessName          String
  displayName           String
  website               String?
  country               String?
  timezone              String    @default("UTC")
  
  // Account status - critical for security
  status                String    @default("active") // active, suspended, deleted
  isDeleted             Boolean   @default(false)
  deletedAt             DateTime?
  
  // Multi-factor security (Phase 2 ready)
  totpEnabled           Boolean   @default(false)
  totpSecret            String?   @db.Text
  
  // Account tiers for feature gating
  tier                  String    @default("starter") // starter, pro, enterprise
  
  // Metadata for extensibility
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations - cascade delete for cleanup
  apiKeys               ApiKey[]
  webhookEndpoints      WebhookEndpoint[]
  webhookEvents         WebhookEvent[]
  auditLogs             AuditLog[]
  merchantSettings      MerchantSettings?
  apiKeyRotations       ApiKeyRotation[]
  paymentIntents        PaymentIntent[]
  charges               Charge[]
  refunds               Refund[]
  subscriptions         Subscription[]
  
  @@index([email])
  @@index([status])
  @@index([isDeleted])
  @@map("merchants")
}

model ApiKey {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  // Key material - pk_live_xxx and hashed sk_live_xxx
  publishableKey        String    @unique // pk_live_xxx
  secretKeyHash         String    @unique // bcrypt hashed
  secretKeyPrefix       String    // Last 4 chars visible to user
  name                  String
  
  // Security restrictions
  ipWhitelist           String[]  @default([]) // Optional IP restriction
  restrictedTo          String[]  @default([]) // Restrict to specific endpoints
  isActive              Boolean   @default(true)
  
  // Usage tracking
  createdAt             DateTime  @default(now())
  lastUsedAt            DateTime?
  expiresAt             DateTime?
  
  // Relations
  rotations             ApiKeyRotation[]
  
  @@index([merchantId])
  @@index([publishableKey])
  @@map("api_keys")
}

model ApiKeyRotation {
  id                    String    @id @default(cuid())
  apiKeyId              String
  apiKey                ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  oldSecretKeyHash      String
  newSecretKeyHash      String
  reason                String    // "scheduled", "compromised", "user_initiated"
  rotatedAt             DateTime  @default(now())
  
  @@index([merchantId])
  @@index([rotatedAt])
  @@map("api_key_rotations")
}

model WebhookEndpoint {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  url                   String
  secret                String    // HMAC-SHA256 key for signature verification
  events                String[]  @default([]) // ["payment.succeeded", "charge.failed"]
  
  // Status tracking for reliability
  isActive              Boolean   @default(true)
  failureCount          Int       @default(0)
  lastFailedAt          DateTime?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  deliveries            WebhookDelivery[]
  
  @@index([merchantId])
  @@index([isActive])
  @@map("webhook_endpoints")
}

model MerchantSettings {
  id                    String    @id @default(cuid())
  merchantId            String    @unique
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  // Notification preferences
  notifyOnPayment       Boolean   @default(true)
  notifyOnRefund        Boolean   @default(true)
  payoutSchedule        String    @default("daily") // daily, weekly, monthly
  webhookRetryCount     Int       @default(3)
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([merchantId])
  @@map("merchant_settings")
}

model AuditLog {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  action                String    // "signin", "signup", "api_key_created", "password_changed", "2fa_enabled"
  resource              String?   // "api_key", "webhook", "settings"
  resourceId            String?
  status                String    // "success", "failure"
  
  // Request context for forensic analysis
  ipAddress             String?
  userAgent             String?
  requestId             String    @unique
  
  // Structured details for compliance
  details               Json      @default("{}")
  createdAt             DateTime  @default(now())
  
  @@index([merchantId])
  @@index([action])
  @@index([createdAt])
  @@index([requestId])
  @@map("audit_logs")
}

// Phase 2+ placeholder tables for complete Stripe-like functionality
model Product {
  id                    String    @id @default(cuid())
  merchantId            String
  
  name                  String
  description           String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([merchantId])
  @@map("products")
}

model Price {
  id                    String    @id @default(cuid())
  merchantId            String
  productId             String
  
  amount                Int       // cents
  currency              String    @default("usd")
  type                  String    // "one_time", "recurring"
  recurringInterval     String?   // "month", "year", "week", "day"
  recurringIntervalCount Int?     // e.g., every 3 months
  trialDays             Int?      // Free trial period
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  subscriptions         Subscription[]
  
  @@index([merchantId])
  @@index([productId])
  @@map("prices")
}

model Customer {
  id                    String    @id @default(cuid())
  merchantId            String
  
  email                 String
  name                  String?
  phone                 String?
  address               Json?     // { street, city, state, zip, country }
  cardTokens            String[]  @default([]) // Array of tokenized cards
  defaultCardLast4      String?
  defaultCardBrand      String?
  defaultCardToken      String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  subscriptions         Subscription[]
  
  @@index([merchantId])
  @@index([email])
  @@map("customers")
}

model PaymentIntent {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  clientSecret          String    @unique
  publishableKey        String    // Which publishable key created this
  
  // Payment details
  amount                Int       // cents
  currency              String    @default("usd")
  status                String    // "requires_payment_method", "requires_confirmation", "succeeded", "processing", "requires_action", "canceled"
  
  // Card & customer info
  customerId            String?   // For linking to customer
  cardToken             String?   // Tokenized card (simulated UUID)
  cardLast4             String?
  cardBrand             String?   // visa, mastercard, amex
  cardExpMonth          Int?
  cardExpYear           Int?
  
  // 3D Secure
  requires3ds           Boolean   @default(false)
  threeDSecureStatus    String?   // "authenticated", "failed"
  
  // Metadata
  metadata              Json      @default("{}")
  description           String?
  receiptEmail          String?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  charges               Charge[]
  
  @@index([merchantId])
  @@index([status])
  @@index([clientSecret])
  @@index([publishableKey])
  @@map("payment_intents")
}

model Charge {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  paymentIntentId       String
  paymentIntent         PaymentIntent @relation(fields: [paymentIntentId], references: [id], onDelete: Cascade)
  
  subscriptionId        String?   // NULL for one-time, populated for recurring
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  // Charge details
  amount                Int       // cents
  currency              String    @default("usd")
  status                String    // "succeeded", "failed", "pending", "refunded"
  
  // Card info
  cardLast4             String
  cardBrand             String
  cardToken             String    // Tokenized
  
  // Fraud & authorization
  fraudCheckStatus      String?   // "passed", "flagged", "high_risk"
  fraudScore            Float     @default(0.0) // 0-100
  authorizationStatus   String    // "approved", "declined", "error"
  authorizationCode     String?
  
  // Reason for failure (if any)
  failureCode           String?   // "card_declined", "expired_card", "insufficient_funds", "lost_card", etc.
  failureMessage        String?
  
  // Refund info
  amountRefunded        Int       @default(0)
  isRefunded            Boolean   @default(false)
  refundedAt            DateTime?
  
  // Metadata
  metadata              Json      @default("{}")
  receiptUrl            String?
  receiptEmail          String?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  refunds               Refund[]
  
  @@index([merchantId])
  @@index([status])
  @@index([authorizationStatus])
  @@index([fraudCheckStatus])
  @@index([paymentIntentId])
  @@index([subscriptionId])
  @@map("charges")
}

model Refund {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  chargeId              String
  charge                Charge    @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  
  amount                Int       // cents
  currency              String    @default("usd")
  status                String    // "pending", "succeeded", "failed"
  reason                String?   // "requested_by_customer", "duplicate", "fraudulent"
  
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now())
  
  @@index([merchantId])
  @@index([chargeId])
  @@index([status])
  @@map("refunds")
}

model Subscription {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  customerId            String
  customer              Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  priceId               String
  price                 Price     @relation(fields: [priceId], references: [id], onDelete: Restrict)
  
  // Subscription status
  status                String    @default("active") // active, paused, cancelled, past_due, incomplete
  cancelAtPeriodEnd     Boolean   @default(false) // Cancel after current period ends
  
  // Billing cycles
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  nextBillingDate       DateTime
  
  // Trial period
  trialStart            DateTime?
  trialEnd              DateTime?
  trialDaysLeft         Int?
  
  // Pricing
  quantity              Int       @default(1)
  
  // Cancellation
  cancelledAt           DateTime?
  cancellationReason    String?   // "customer_request", "payment_failure", "merchant_request"
  
  // Retry count for failed charges
  failureCount          Int       @default(0)
  lastFailureAt         DateTime?
  
  // Metadata
  metadata              Json      @default("{}")
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  charges               Charge[]
  
  @@index([merchantId])
  @@index([customerId])
  @@index([status])
  @@index([nextBillingDate])
  @@index([currentPeriodEnd])
  @@unique([merchantId, customerId, priceId])
  @@map("subscriptions")
}

model WebhookEvent {
  id                    String    @id @default(cuid())
  merchantId            String
  merchant              Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  type                  String    // "payment.succeeded", "charge.refunded", "subscription.created", etc.
  dataObject            Json      // The event payload
  
  // Delivery state
  status                String    @default("pending") // pending, sent, failed, retrying
  deliveryAttempts      Int       @default(0)
  lastDeliveryAt        DateTime?
  nextRetryAt           DateTime?
  
  // Error info (if failed)
  lastError             String?
  lastErrorCode         String?
  lastHttpStatus        Int?
  
  // Timestamps
  createdAt             DateTime  @default(now())
  expiresAt             DateTime  @default(dbgenerated("now() + interval '7 days'"))
  
  // Relations
  deliveries            WebhookDelivery[]
  
  @@index([merchantId])
  @@index([type])
  @@index([status])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@map("webhook_events")
}

model WebhookDelivery {
  id                    String    @id @default(cuid())
  webhookEndpointId     String
  webhookEndpoint       WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)
  
  eventId               String
  event                 WebhookEvent? @relation(fields: [eventId], references: [id], onDelete: SetNull)
  
  // Request/response
  requestPayload        Json
  responseStatus        Int?
  responsePayload       Json?
  
  // Headers (for debugging)
  headers               Json
  signature             String    // HMAC signature
  
  // Timing
  duration              Int       // milliseconds
  createdAt             DateTime  @default(now())
  
  @@index([webhookEndpointId])
  @@index([eventId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}
